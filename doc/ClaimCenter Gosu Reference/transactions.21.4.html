<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <!-- MOTW-DISABLED saved from url=(0014)about:internet -->
    <title>Running Code in an Entirely New Bundle</title>
    <link rel="StyleSheet" href="css/transactions.css" type="text/css" media="all" />
    <link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" />
    <link rel="StyleSheet" href="css/css-guidewire-extra.css" type="text/css" media="all" />
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/context.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/towwhdir.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/wwhpagef.js"></script>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        var  WebWorksRootPath = "";
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        // Set reference to top level help frame
        //
        var  WWHFrame = WWHGetWWHFrame("", true);
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2" src="scripts/expand.js"></script>
    <!-- THE FOLLOWING IS A GUIDEWIRE STYLE DEFINITION FOR THE LINK TO THIS FEATURE -->
    <link rel="StyleSheet" href="css/css-guidewire-extra.css" type="text/css" media="all" />
    <!-- THE FOLLOWING IS A GUIDEWIRE GSCRIPT FUNCTION FOR THE LINK TO THIS FEATURE -->
    <script type="text/javascript">
function guidewire_selectall()
{
var text_val=eval("document.linktothisurlform.urlfield");
text_val.focus();
text_val.select();
}
</script>
  </head>
  <body onLoad="WWHUpdate();" onUnload="WWHUnload();" onKeyDown="WWHHandleKeyDown((document.all||document.getElementById||document.layers)?event:null);" onKeyPress="WWHHandleKeyPress((document.all||document.getElementById||document.layers)?event:null);" onKeyUp="WWHHandleKeyUp((document.all||document.getElementById||document.layers)?event:null);">
    <!-- THE FOLLOWING IS A GUIDEWIRE DIV FOR THE 'LINK TO THIS' FEATURE -->
    <div id="linkToThisPage" class="popup" style="display: none;">
      <div class="popupTitle">Link Directly to This Page 
           <a href="#" onclick="var thePopup = getElementById('linkToThisPage');thePopup.style.display='none';return false;"><img class="popupClosebox" src="wwhelp/wwhimpl/common/images/close.gif" /></a></div>
      <div style="padding:6px;">
        <div class="popupText" id="linkToThisPageBookmark">An error has occurred if you see this messsage.</div>
        <form name="linktothisurlform" method="post" action="" style="width:275px;margin:0px">
          <input type="text" class="popupURLText" id="linkToThisPageURL" name="urlfield" rows="1" cols="55" onClick="guidewire_selectall();" onFocus="guidewire_selectall();"></input>
        </form>
      </div>
    </div>
    <br />
    <div class="WebWorks_Breadcrumbs" style="text-align: left;">
      <span>Gosu Reference Guide</span> : 
    <span class="WebWorks_Breadcrumbs" style="text-align: left;"><a class="WebWorks_Breadcrumb_Link" href="transactions.21.1.html#1561481">Bundles and Transactions</a> : Running Code in an Entirely New Bundle</span></div>
    <hr align="left" />
    <blockquote>
      <div class="H1_-_Heading_1"><a name="1561481">Running Code in an Entirely New Bundle</a></div>
      <div class="B_-_Body"><a name="1574159">Typical Gosu code interacts with database transactions by adding modifying entities in the current bundle or </a>adding new entities to the bundle. The bundle and ClaimCenter automatically manage the low level parts of database transactions. Only in rare cases your code must commit a bundle explicitly. Refer to the previous section for more information about bundles and how to use them.</div>
      <div class="B_-_Body"><a name="1558771">In very rare cases, you can run Gosu code in an entirely </a><span class="s_-_strong">new</span> database transaction. In other words, you sometimes must create a different transaction from the current transaction.</div>
      <div class="B_-_Body"><a name="1558814">Only create your own transaction in the following cases:</a></div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline;">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap;">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1558633">Create a new bundle if your code modifies entities to commit independent of the </a><span class="s_-_strong">success</span> of the surrounding code. For example, some workflow asychronous actions or PCF user interface code might need to create a new bundle.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline;">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap;">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1558706">Create a new bundle if your code represents a separate asynchronous actions from surrounding code</a></div>
            </td>
          </tr>
        </table>
      </div>
      <div class="BI_-_Bullet_Item_outer" style="margin-left: 57pt">
        <table border="0" cellspacing="0" cellpadding="0" summary="" role="presentation">
          <tr style="vertical-align: baseline;">
            <td>
              <div class="BI_-_Bullet_Item_inner" style="width: 15pt; white-space: nowrap;">
                <span class="bu_-_bullet">•	</span>
              </div>
            </td>
            <td width="100%">
              <div class="BI_-_Bullet_Item_inner"><a name="1558596">Create a new bundle if your Gosu calls Java code that spawns a new thread within the server, such as a timer </a>or scheduled event. It is important that no two threads share a bundle.</div>
            </td>
          </tr>
        </table>
      </div>
      <div class="B_-_Body"><a name="1559109">To run code within a separate transaction, you must create a </a><span class="e_-_emphasis">Gosu</span><span class="e_-_emphasis">&nbsp;</span><span class="e_-_emphasis">block</span>, which is a special type of Gosu function that you define in-line within another function. You can pass a block to other functions to invoke as appropriate. For detailed information about blocks, see <a href="javascript:WWHClickedPopup('gosu', 'blocks.17.1.html#1445150', '');" title="Gosu Blocks">“Gosu Blocks”</a>.</div>
      <div class="B_-_Body"><a name="1558859">You can create a new bundle with a static method </a><span class="cv_-_computer_voice">runWithNewBundle</span> on the <span class="cv_-_computer_voice">Transaction</span> class. You pass the <span class="cv_-_computer_voice">runWithNewBundle</span> method a Gosu&nbsp;block that takes one argument of type <span class="cv_-_computer_voice">Bundle</span>, which is an entirely new bundle created just for your code within the block<span class="cv_-_computer_voice">.</span> </div>
      <div class="B_-_Body"><a name="1559180">The syntax is:</a></div>
      <PRE class="CF_-_Code_First_Line"><a name="1559150">uses gw.transaction.Transaction</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1558860">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1559164">...</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1559165">&nbsp;</a></PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1559191">Transaction.runWithNewBundle( \ bundle -&gt; </a><span class="pt_-_parameter_in_table">YOUR_BLOCK_CODE_HERE</span> )</PRE>
      <div class="B_-_Body"><a name="1559192">Your Gosu code within the block can add entities to the bundle as appropriate using the </a><span class="cv_-_computer_voice">bundle.add(</span><span class="ps_-_parameter_in_code_snippets">entity</span><span class="cv_-_computer_voice">)</span> method. </div>
      <div class="B_-_Body"><a name="1559230">Gosu runs this code immediately (synchronously) and if the block succeeds with no exceptions, </a><span class="cv_-_computer_voice">runWithNewBundle</span> automatically commits the new bundle after your code completes. For the most concise and easy-to-understand code, Guidewire encourages you to use this automatic commit behavior rather than committing the bundle explicitly. If your code detects error conditions, it can roll back the database transaction associated with this bundle simply by throwing an exception from the Gosu block.</div>
      <div class="B_-_Body"><a name="1602437">The following example demonstrates how to create a new bundle and run code that creates a new entity in that </a>bundle, and modifies some fields. Note that the current transaction is an argument to the block, but it is redundant since Gosu sets the current (ambient) bundle inside the block to this new block automatically.</div>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602439">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602440">gw.transaction.Transaction.runWithNewBundle( \b -&gt; {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602441">&nbsp;</a>&nbsp;var me = new MyEntity()&nbsp;&nbsp;</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602442">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602443">&nbsp;</a>&nbsp;me.FirstName = firstName</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602444">&nbsp;</a>&nbsp;me.LastName = lastName</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602445">&nbsp;</a>&nbsp;me.PrimaryAddress = address</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602446">&nbsp;</a>&nbsp;me.EmailAddress1 = email</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602447">&nbsp;</a>&nbsp;me.WorkPhone = workPhone</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602448">&nbsp;</a>&nbsp;me.PrimaryPhone = primaryPhoneType</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602449">&nbsp;</a>&nbsp;me.TaxID = taxId</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602450">&nbsp;</a>&nbsp;me.FaxPhone = faxPhone</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602451">} )</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1602452">&nbsp;</a></PRE>
      <div class="B_-_Body"><a name="1601851">The following example method from a web service implementation demonstrates how to create a new bundle </a>and call an auxiliary function that takes a <span class="cv_-_computer_voice">MyClass</span> entity and a bundle:</div>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601852">...</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601853">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601854">public function myaction(f : MyClass) : void {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601855">&nbsp;</a>&nbsp;Transaction.runWithNewBundle( \ bundle -&gt; MyClass.doSomething(f, bundle))</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601856">}</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601857">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1601858">...</a></PRE>
      <div class="B_-_Body"><a name="1562945">In that example, the block was self-contained and did not need to transfer any information to the code within the </a><span class="cv_-_computer_voice">myaction</span> method. </div>
      <div class="B_-_Body"><a name="1561559">In other cases, you might need to get information to your block or return information back from your block. You </a>can do this using the <span class="e_-_emphasis">variable capturing</span> features of blocks. This feature shares variables in the current scope with the original calling context of the block and also code within the block. For more information about this feature, see <a href="javascript:WWHClickedPopup('gosu', 'blocks.17.4.html#1443613', '');" title="Variable Scope and Capturing Variables In Blocks">“Variable Scope and Capturing Variables In Blocks”</a>.</div>
      <div class="B_-_Body"><a name="1561571">The following example demonstrates variable capturing by creating a local variable in the outer scope </a>(<span class="cv_-_computer_voice">synchronizeAgency</span>) but then setting its value from within the block. Consequently, the outer scope can return that value as a return value from the method.</div>
      <PRE class="CM_-_Code_Middle_Line"><a name="1553427">public function synchronizeMyObject(f : MyClass) : boolean {</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1552502">    var res : boolean</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557082">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557090">&nbsp;</a>&nbsp;&nbsp;&nbsp;// the local variable "res" and the parameter "f" is captured by the block. </PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557234">&nbsp;</a>&nbsp;&nbsp;&nbsp;// Both are effectively shared between the current function and the block</PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557235">    Transaction.runWithNewBundle( \ bundle -&gt; { res = MyClass.doSomething(f, bundle) })</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557138">&nbsp;</a></PRE>
      <PRE class="CM_-_Code_Middle_Line"><a name="1557141">&nbsp;</a>&nbsp;&nbsp;&nbsp;// return the value that was set in the block using the shared (captured) variable</PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1553463">    return res </a></PRE>
      <PRE class="CL_-_Code_Last_Line"><a name="1553839">}</a></PRE>
      <div class="B_-_Body"><a name="1557262">Similarly, you can use variable capturing to provide additional information to your block. In the example earlier, </a>notice that the variable <span class="cv_-_computer_voice">f</span> is a parameter to the outer function. It is captured by the block and can be read (or changed) by the block. </div>
      <div class="NW_-_Note_Warning">
        <span class="w_-_warning">WARNING  </span><a name="1560610">Be extremely careful only to commit entity changes at appropriate times, or else serious </a>data integrity errors occur. If an entity’s changes commit to the database, changes can no longer be rolled back if errors occur that must undo related database changes. For example, all rule set code must never commit data explicitly since committing happens automatically if all related changes including rule set code succeeds.</div>
      <div class="H2_-_Heading_2"><a name="1583029">Create Bundle For a Specific ClaimCenter User</a></div>
      <div class="B_-_Body"><a name="1583030">The </a><span class="cv_-_computer_voice">gw.transaction.Transaction</span> class has an alternate version of the <span class="cvt_-_computer_voice_table">runWithNewBundle</span> method to create a bundle with a specific user associated with it. This is intended for use in contexts in which there is no built-in user context, such in the startable plugins feature. The method signature is:</div>
      <div class="CS_-_Code_Single_Line"><a name="1583031">gw.transaction.Transaction.runWithNewBundle(\ bundle -&gt; </a><span class="pc_-_parameter_in_code">YOUR_BLOCK_BODY</span>, user)</div>
      <div class="B_-_Body"><a name="1583047">For that second method argument, you can pass either a </a><span class="cv_-_computer_voice">User</span> entity or a <span class="cv_-_computer_voice">String</span> that is the user name.</div>
      <div class="H2_-_Heading_2"><a name="1602225">Warning about Transaction Class Confusion</a></div>
      <div class="B_-_Body"><a name="1602229">There is more than one </a><span class="cv_-_computer_voice">Transaction</span> type in Gosu for ClaimCenter. Do not confuse the class <span class="cv_-_computer_voice">gw.transaction.Transaction</span> with the <span class="cv_-_computer_voice">Transaction</span> entities or related typelists.</div>
      <div class="B_-_Body"><a name="1602230">If you use these APIs, you might want to use a Gosu </a><span class="cv_-_computer_voice">uses</span> statement such as the following:</div>
      <div class="CS_-_Code_Single_Line"><a name="1602231">uses gw.transaction.Transaction</a></div>
      <div class="B_-_Body"><a name="1602232">This topic is about the class in the </a><span class="cv_-_computer_voice">gw.transaction</span> package, in other words: <span class="cv_-_computer_voice">gw.transaction.Transaction</span>. </div>
      <script type="text/javascript" language="JavaScript1.2">
        <!--
          // Clear related topics
          //
          WWHClearRelatedTopics();

          document.writeln(WWHRelatedTopicsInlineHTML());
        // -->
      </script>
    </blockquote>
    <script type="text/javascript" language="JavaScript1.2">
      <!--
        document.write(WWHRelatedTopicsDivTag() + WWHPopupDivTag() + WWHALinksDivTag());
      // -->
    </script>
  </body>
</html>